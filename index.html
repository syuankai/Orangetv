<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrangePlayer - 極致毛玻璃官方版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root {
            --glass: rgba(255, 255, 255, 0.07);
            --orange: #f97316;
            --blur-val: 45px;
        }

        body {
            font-family: 'SF Pro Display', 'Noto Sans TC', sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(var(--blur-val));
            -webkit-backdrop-filter: blur(var(--blur-val));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #bg-layer {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: background-image 1.2s ease-in-out;
        }
        #bg-layer::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
        }
        #bg-layer.active-blur::after {
            backdrop-filter: blur(20px) brightness(0.6);
        }

        #sidebar {
            width: 280px;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            z-index: 100;
        }
        #sidebar.collapsed { margin-left: -280px; }

        .nav-link {
            cursor: pointer;
            border-radius: 20px;
            margin: 4px 16px;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.45);
            font-weight: 700;
            transition: 0.3s;
        }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-link.active { color: var(--orange); border: 1px solid rgba(249, 115, 22, 0.25); }

        .card-item {
            border-radius: 30px;
            overflow: hidden;
            transition: 0.4s;
            cursor: pointer;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .card-item:hover { transform: translateY(-10px); border-color: var(--orange); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(60px);
            -webkit-backdrop-filter: blur(60px);
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.open { display: flex; flex-direction: column; align-items: center; }

        #close-btn {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 1100;
            padding: 18px;
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s;
        }
        #close-btn:hover { background: var(--orange); transform: rotate(90deg) scale(1.1); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="bg-layer" class="active-blur"></div>

    <aside id="sidebar" class="glass-panel h-full">
        <div class="p-8 h-full flex flex-col">
            <div class="flex items-center gap-4 mb-16">
                <div class="bg-orange-500 p-3.5 rounded-2xl text-white shadow-2xl shadow-orange-500/40">
                    <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black italic tracking-tighter leading-none">ORANGE</span>
                    <span class="text-[9px] font-black text-orange-500 tracking-[0.4em] uppercase opacity-90">Player</span>
                </div>
            </div>

            <nav class="flex-1 space-y-1">
                <div onclick="showPage('home')" id="n-home" class="nav-link active"><i data-lucide="layout-grid"></i><span class="ml-4 text-sm">首頁推薦</span></div>
                <div onclick="showPage('m3u8')" id="n-m3u8" class="nav-link"><i data-lucide="link"></i><span class="ml-4 text-sm">解析 M3U8</span></div>
                <div onclick="showPage('music')" id="n-music" class="nav-link"><i data-lucide="folder-heart"></i><span class="ml-4 text-sm">本地媒體</span></div>
                <div onclick="showPage('fav')" id="n-fav" class="nav-link"><i data-lucide="bookmark"></i><span class="ml-4 text-sm">雲端儲存</span></div>
                <div onclick="showPage('history')" id="n-history" class="nav-link"><i data-lucide="history"></i><span class="ml-4 text-sm">雲端歷史</span></div>
            </nav>

            <div class="pt-6 border-t border-white/10">
                <div onclick="setPanel(true)" class="nav-link"><i data-lucide="settings-2"></i><span class="ml-4 text-sm">介面客製化</span></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-screen overflow-y-auto relative">
        <header class="p-6 md:px-12 sticky top-0 z-50 flex items-center gap-6">
            <button onclick="sideToggle()" class="p-4 glass-panel rounded-2xl hover:text-orange-500 transition">
                <i data-lucide="menu"></i>
            </button>
            <div class="relative flex-1">
                <input type="text" id="mainSearch" placeholder="搜尋影片、影集、或直播頻道..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-14 focus:border-orange-500 outline-none backdrop-blur-3xl transition-all">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-zinc-500"></i>
            </div>
        </header>

        <div class="px-6 md:px-12 pb-32 max-w-7xl mx-auto">
            <div id="page-home" class="view">
                <div class="flex items-center gap-4 mb-10">
                    <div class="w-1.5 h-10 bg-orange-500 rounded-full"></div>
                    <h2 class="text-3xl font-black italic uppercase tracking-tighter">Global Explore</h2>
                </div>
                <div id="grid-home" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-8"></div>
            </div>

            <div id="page-m3u8" class="view hidden pt-10">
                <div class="glass-panel p-14 max-w-xl mx-auto rounded-[3.5rem] text-center">
                    <h2 class="text-2xl font-black mb-8 text-orange-500 uppercase tracking-widest">URL Decoder</h2>
                    <input type="text" id="raw-url" placeholder="粘貼 M3U8 / MP4 連結" class="w-full bg-black/40 border border-white/10 rounded-2xl p-5 mb-6 text-center focus:border-orange-500 outline-none">
                    <button onclick="directPlay()" class="w-full bg-orange-600 py-4 rounded-2xl font-black text-lg hover:scale-[1.02] active:scale-95 transition">開始播放</button>
                </div>
            </div>

            <div id="page-music" class="view hidden pt-10">
                <div class="glass-panel p-10 max-w-2xl mx-auto rounded-[3rem]">
                    <input type="file" id="up-file" multiple class="hidden" onchange="loadLocal(this)">
                    <button onclick="document.getElementById('up-file').click()" class="w-full py-28 border-2 border-dashed border-white/10 rounded-[2.5rem] text-zinc-500 hover:border-orange-500 hover:text-orange-500 transition-all flex flex-col items-center">
                        <i data-lucide="file-video" class="w-14 h-14 mb-4"></i>
                        <span class="font-black text-sm tracking-[0.4em] uppercase">點擊載入本地檔案</span>
                    </button>
                    <div id="local-list" class="mt-8 space-y-3"></div>
                </div>
            </div>

            <div id="page-fav" class="view hidden"><h2 class="text-3xl font-black mb-10 italic border-l-8 border-orange-500 pl-5">FAVORITES</h2><div id="grid-fav" class="grid grid-cols-2 lg:grid-cols-6 gap-8"></div></div>
            <div id="page-history" class="view hidden"><h2 class="text-3xl font-black mb-10 italic border-l-8 border-orange-500 pl-5">HISTORY</h2><div id="grid-history" class="grid grid-cols-2 lg:grid-cols-6 gap-8"></div></div>
        </div>
    </main>

    <!-- 頂級播放器模組 -->
    <div id="main-player-ui" class="modal-overlay">
        <button id="close-btn" onclick="killPlayer()"><i data-lucide="x"></i></button>
        
        <div class="w-full max-w-6xl mt-10 animate-in zoom-in duration-500">
            <div class="aspect-video bg-black rounded-[3rem] overflow-hidden border border-white/10 mb-8 shadow-2xl">
                <video id="core-v" class="video-js vjs-default-skin vjs-big-play-centered" controls></video>
            </div>
            
            <div class="glass-panel p-10 rounded-[3rem] mb-20">
                <div class="flex flex-col md:flex-row justify-between items-start gap-8 mb-8">
                    <div>
                        <h1 id="core-title" class="text-4xl font-black italic tracking-tighter mb-4">影片標題</h1>
                        <p id="core-desc" class="text-zinc-400 text-sm leading-relaxed max-w-3xl">影片簡介加載中...</p>
                    </div>
                    <button onclick="hitFav()" id="fav-node" class="bg-white/5 border border-white/10 px-10 py-5 font-black flex items-center gap-4 rounded-2xl hover:bg-orange-600 transition shrink-0">
                        <i data-lucide="heart"></i> <span>儲存</span>
                    </button>
                </div>
                <div id="core-eps" class="grid grid-cols-2 sm:grid-cols-5 md:grid-cols-8 gap-3 border-t border-white/10 pt-8"></div>
            </div>
        </div>
    </div>

    <!-- 設定視窗 -->
    <div id="setting-win" class="modal-overlay">
        <div class="glass-panel p-12 w-full max-w-md mx-4 rounded-[3rem]">
            <h3 class="text-2xl font-black mb-10 text-orange-500 text-center uppercase italic">Style Settings</h3>
            <div class="space-y-8">
                <div>
                    <label class="block text-[10px] font-bold text-zinc-500 mb-3 uppercase tracking-widest">雲端同步背景圖片</label>
                    <input type="file" id="bg-f" accept="image/*" class="hidden" onchange="readImg(this)">
                    <button onclick="document.getElementById('bg-f').click()" class="w-full py-4 bg-white/5 border border-white/10 rounded-xl font-bold hover:bg-white/10 transition">從設備選擇</button>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-zinc-500 mb-3 uppercase tracking-widest">或者貼上圖片 URL</label>
                    <input type="text" id="bg-url-box" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl outline-none focus:border-orange-500 text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-zinc-500 mb-3 uppercase tracking-widest">背景模糊強度</label>
                    <div class="flex gap-4">
                        <button onclick="setBlur('glass')" id="b-glass" class="flex-1 py-4 rounded-xl border border-white/10 font-bold transition">強效毛玻璃</button>
                        <button onclick="setBlur('clear')" id="b-clear" class="flex-1 py-4 rounded-xl border border-white/10 font-bold transition">無模糊原圖</button>
                    </div>
                </div>
                <div class="flex gap-4 pt-6">
                    <button onclick="writeUI()" class="flex-1 bg-orange-600 py-4 rounded-xl font-black shadow-xl shadow-orange-600/40">儲存配置</button>
                    <button onclick="setPanel(false)" class="px-8 bg-zinc-800 py-4 rounded-xl font-black text-xs">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/env';
        let vjs, cur, dbData = { fav: [], history: [] }, token = localStorage.getItem('op_tk') || "";
        let ui = { bg: "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564", mode: "glass" };

        const SOURCES = [
            "https://cj.lziapi.com/api.php/provide/vod/at/json",
            "https://suoniapi.com/api.php/provide/vod/at/json",
            "https://hhzyapi.com/api.php/provide/vod/at/json"
        ];

        window.onload = async () => {
            lucide.createIcons();
            vjs = videojs('core-v', { fluid: true, playbackRates: [0.5, 1, 1.5, 2] });
            await Promise.all([initUI(), initDB()]);
            loadHome();
            document.getElementById('mainSearch').onkeydown = e => e.key === 'Enter' && search(e.target.value);
        };

        async function initUI() {
            try {
                const r = await fetch(`${API}?action=get_settings`, { headers: {'Authorization': token} });
                if (r.ok) ui = await r.json();
                renderUI();
            } catch(e) { renderUI(); }
        }

        async function initDB() {
            try {
                const r = await fetch(API, { headers: {'Authorization': token} });
                const json = await r.json();
                if (json.data) {
                    dbData = json.data;
                    render('fav', dbData.fav);
                    render('history', dbData.history);
                }
            } catch(e) {}
        }

        function renderUI() {
            const bg = document.getElementById('bg-layer');
            bg.style.backgroundImage = `url('${ui.bg}')`;
            bg.className = ui.mode === 'glass' ? 'active-blur' : '';
            document.getElementById('bg-url-box').value = ui.bg.startsWith('data:') ? "[Custom Cloud Image]" : ui.bg;
            document.getElementById('b-glass').classList.toggle('border-orange-500', ui.mode === 'glass');
            document.getElementById('b-clear').classList.toggle('border-orange-500', ui.mode === 'clear');
        }

        async function loadHome() {
            const grid = document.getElementById('grid-home');
            grid.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse text-orange-500 font-black tracking-widest text-xs">COLLECTING LATEST CONTENT...</div>';
            try {
                const r = await fetch(`${API}?action=douban`, { headers: {'Authorization': token} });
                const json = await r.json();
                const list = json.subjects.map(s => ({ vod_name: s.title, vod_pic: s.images.large, vod_content: s.title + " (豆瓣推薦內容)", _db: true }));
                render('home', list);
            } catch(e) {
                const r = await fetch(SOURCES[0]);
                const d = await r.json();
                render('home', d.list.slice(0, 24));
            }
        }

        async function search(kw, silent = false) {
            if (!kw) return;
            if (!silent) {
                showPage('home');
                document.getElementById('grid-home').innerHTML = '<div class="col-span-full py-20 text-center text-orange-500 font-black text-xs uppercase">Connecting to global providers...</div>';
            }
            const pool = await Promise.all(SOURCES.map(u => fetch(`${u}?wd=${encodeURIComponent(kw)}`).then(r => r.json()).catch(() => ({list:[]}))));
            const merged = pool.flatMap(p => p.list || []);
            if (silent) return merged[0];
            render('home', merged);
        }

        async function openV(item) {
            document.getElementById('main-player-ui').classList.add('open');
            document.getElementById('core-title').innerText = item.vod_name;
            document.getElementById('core-desc').innerText = item.vod_content ? item.vod_content.replace(/<[^>]+>/g, '') : "暫無影片詳細介紹。";
            
            let target = item;
            if (item._db) {
                target = await search(item.vod_name, true);
                if (!target) { alert('此資源當前不可用'); killPlayer(); return; }
            }

            cur = target;
            const urlRaw = target.vod_play_url || "";
            const eps = urlRaw.includes('#') ? urlRaw.split('#').map(l => l.split('$')) : [urlRaw.split('$')];
            const box = document.getElementById('core-eps');
            box.innerHTML = '';
            
            eps.forEach((p, i) => {
                const b = document.createElement('button');
                b.className = "bg-white/5 border border-white/10 p-5 rounded-2xl text-[10px] font-black hover:bg-orange-600 transition truncate shadow-lg";
                b.innerText = p[0] || `集數 ${i+1}`;
                b.onclick = () => {
                    const u = p[p.length-1];
                    vjs.src({ src: u, type: u.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4' });
                    vjs.play();
                    pushData('history', target);
                };
                box.appendChild(b);
            });
            if (box.firstChild) box.firstChild.click();
            favState();
        }

        function render(type, data) {
            const container = document.getElementById(`grid-${type}`);
            if (!container) return;
            container.innerHTML = '';
            data.forEach(v => {
                const card = document.createElement('div');
                card.className = "card-item";
                card.onclick = () => openV(v);
                card.innerHTML = `
                    <div class="aspect-[3/4.5] relative">
                        <img src="${v.vod_pic}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-60"></div>
                        <div class="absolute bottom-3 left-3 bg-orange-600 text-[9px] font-black px-2 py-1 rounded shadow-xl uppercase">${v._db?'Douban':(v.vod_remarks||'HD')}</div>
                    </div>
                    <div class="p-4 text-[11px] font-black truncate text-zinc-400 text-center uppercase tracking-tighter">${v.vod_name}</div>
                `;
                container.appendChild(card);
            });
        }

        function pushData(action, payload) {
            if (action === 'history') {
                dbData.history = [payload, ...dbData.history.filter(x => x.vod_name !== payload.vod_name)].slice(0, 30);
                render('history', dbData.history);
                cloud('history', dbData.history);
            } else {
                const has = dbData.fav.some(x => x.vod_name === payload.vod_name);
                if (has) dbData.fav = dbData.fav.filter(x => x.vod_name !== payload.vod_name);
                else dbData.fav.unshift(payload);
                render('fav', dbData.fav);
                cloud('save', dbData.fav);
                favState();
            }
        }

        function cloud(action, payload) {
            fetch(API, { 
                method: 'POST', 
                headers: { 'Authorization': token, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ action, payload, token }) 
            });
        }

        window.sideToggle = () => document.getElementById('sidebar').classList.toggle('collapsed');
        window.showPage = p => {
            document.querySelectorAll('.view').forEach(s => s.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`n-${p}`).classList.add('active');
            if (window.innerWidth < 1024) sideToggle();
        };

        window.setPanel = s => document.getElementById('setting-win').classList.toggle('open', s);
        window.setBlur = m => { ui.mode = m; renderUI(); };
        window.readImg = i => {
            if (i.files && i.files[0]) {
                const r = new FileReader();
                r.onload = e => { ui.bg = e.target.result; renderUI(); };
                r.readAsDataURL(i.files[0]);
            }
        };

        window.writeUI = async () => {
            const url = document.getElementById('bg-url-box').value;
            if (url && !url.includes('[Custom')) ui.bg = url;
            renderUI();
            await fetch(`${API}?action=set_settings`, {
                method: 'POST',
                headers: { 'Authorization': token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ payload: ui, token })
            });
            setPanel(false);
        };

        window.killPlayer = () => { vjs.pause(); document.getElementById('main-player-ui').classList.remove('open'); };
        window.hitFav = () => pushData('fav', cur);
        window.directPlay = () => { const u = document.getElementById('raw-url').value; u && openV({ vod_name: "直播源解析", vod_play_url: `LIVE$${u}`, vod_content: "手動解析連結。" }); };
        window.loadLocal = i => {
            const list = Array.from(i.files).map(f => `${f.name}$${URL.createObjectURL(f)}`);
            if (list.length) openV({ vod_name: "本地播放庫", vod_play_url: list.join('#'), vod_content: "從本地設備加載的檔案。" });
        };

        function favState() {
            const is = cur && dbData.fav.some(x => x.vod_name === cur.vod_name);
            const b = document.getElementById('fav-node');
            b.classList.toggle('bg-orange-600', is);
            b.querySelector('span').innerText = is ? '已儲存' : '儲存';
        }
    </script>
</body>
</html>
