<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORANGEPLAYER - 全功能修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root {
            --orange: #f97316;
            --apple-blur: blur(45px) saturate(190%) brightness(1.05);
        }

        body {
            font-family: 'SF Pro Display', 'Noto Sans TC', sans-serif;
            background: #000;
            color: #fff;
            height: 100vh;
            width: 100vw;
            margin: 0;
            overflow: hidden;
            display: flex;
        }

        /* 背景與毛玻璃 */
        #bg-layer {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: background-image 1.2s ease;
        }
        #bg-layer.glass-mode::after {
            content: '';
            position: absolute;
            inset: 0;
            backdrop-filter: var(--apple-blur);
            -webkit-backdrop-filter: var(--apple-blur);
            background: rgba(0,0,0,0.5);
        }

        /* 側邊欄修復 */
        #sidebar {
            width: 280px;
            height: 100vh;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
        }
        #sidebar.collapsed {
            width: 0;
            transform: translateX(-280px);
            opacity: 0;
            pointer-events: none;
        }

        .nav-link {
            cursor: pointer;
            border-radius: 18px;
            margin: 4px 16px;
            padding: 14px 22px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.4);
            font-weight: 700;
            transition: all 0.3s;
        }
        .nav-link:hover { background: rgba(255,255,255,0.06); color: #fff; }
        .nav-link.active { 
            background: var(--orange); 
            color: #fff; 
            box-shadow: 0 12px 30px rgba(249, 115, 22, 0.4);
        }

        /* 內容區 */
        main {
            flex-grow: 1;
            height: 100vh;
            overflow-y: auto;
            position: relative;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 24px;
        }

        .card-item {
            border-radius: 28px;
            overflow: hidden;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.4s cubic-bezier(0.1, 1, 0.1, 1);
            cursor: pointer;
        }
        .card-item:hover { transform: translateY(-10px); border-color: var(--orange); }

        /* 彈窗 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: none;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(50px) saturate(200%);
            padding: 20px;
            overflow-y: auto;
        }
        .modal-overlay.open { display: flex; flex-direction: column; align-items: center; }

        .glass-card {
            background: rgba(255,255,255,0.07);
            backdrop-filter: blur(35px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 32px;
        }

        input#searchInput {
            width: 100%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 22px;
            padding: 18px 24px 18px 60px;
            outline: none;
            color: #fff;
            transition: 0.3s;
        }
        input#searchInput:focus { border-color: var(--orange); background: rgba(255,255,255,0.12); }
    </style>
</head>
<body>

    <div id="bg-layer" class="glass-mode"></div>

    <!-- 側邊欄 -->
    <aside id="sidebar">
        <div class="p-8 h-full flex flex-col">
            <div class="flex items-center gap-4 mb-14">
                <div class="bg-orange-500 p-3 rounded-2xl text-white shadow-xl shadow-orange-500/40">
                    <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-2xl font-black italic tracking-tighter leading-none">ORANGE</span>
                    <span class="text-[9px] font-black text-orange-500 tracking-[0.4em] uppercase">Player</span>
                </div>
            </div>

            <nav class="flex-1 space-y-1">
                <div onclick="showPage('home')" id="n-home" class="nav-link active"><i data-lucide="layout-grid" class="w-5 h-5"></i><span class="ml-4 text-sm">影視探索</span></div>
                <div onclick="showPage('m3u8')" id="n-m3u8" class="nav-link"><i data-lucide="link-2" class="w-5 h-5"></i><span class="ml-4 text-sm">M3U8 解析</span></div>
                <div onclick="showPage('local')" id="n-local" class="nav-link"><i data-lucide="file-video" class="w-5 h-5"></i><span class="ml-4 text-sm">本地歌單</span></div>
                <div onclick="showPage('fav')" id="n-fav" class="nav-link"><i data-lucide="heart" class="w-5 h-5"></i><span class="ml-4 text-sm">我的儲存</span></div>
                <div onclick="showPage('history')" id="n-history" class="nav-link"><i data-lucide="history" class="w-5 h-5"></i><span class="ml-4 text-sm">雲端歷史</span></div>
            </nav>

            <div class="pt-6 border-t border-white/10">
                <div onclick="openSettings(true)" class="nav-link hover:text-orange-500">
                    <i data-lucide="sliders" class="w-5 h-5"></i>
                    <span class="ml-4 text-sm">後台配置</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- 主內容區 -->
    <main>
        <header class="p-6 md:px-12 sticky top-0 z-50 flex items-center gap-6 bg-transparent">
            <button onclick="toggleSidebar()" class="p-4 glass-card rounded-2xl hover:text-orange-500 transition shadow-lg">
                <i data-lucide="menu"></i>
            </button>
            <div class="relative flex-1 max-w-3xl">
                <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 text-zinc-500 pointer-events-none"></i>
                <input type="text" id="searchInput" placeholder="全網併發搜尋資源站 30+ 站點...">
            </div>
        </header>

        <div class="px-6 md:px-12 pb-32 max-w-7xl mx-auto">
            <!-- 影視頁面 -->
            <div id="page-home" class="view-page">
                <div class="flex justify-between items-end mb-10">
                    <h2 class="text-3xl font-black italic uppercase border-l-4 border-orange-500 pl-4 tracking-tighter">Spotlight</h2>
                    <span id="search-status" class="text-[10px] font-bold text-orange-500 uppercase tracking-widest hidden">Searching...</span>
                </div>
                <div id="grid-home" class="movie-grid"></div>
            </div>

            <!-- M3U8 頁面 -->
            <div id="page-m3u8" class="view-page hidden py-20">
                <div class="glass-card p-12 max-w-xl mx-auto text-center">
                    <h2 class="text-2xl font-black mb-6 text-orange-500 italic uppercase">Stream Decoder</h2>
                    <input type="text" id="m3u8-url" placeholder="輸入 M3U8 網址..." class="w-full bg-black/40 border border-white/10 p-5 mb-4 text-center focus:border-orange-500 outline-none rounded-xl">
                    <button onclick="playM3U8()" class="w-full bg-orange-600 py-4 rounded-xl font-black shadow-lg shadow-orange-600/30">立即解析</button>
                </div>
            </div>

            <!-- 本地頁面 -->
            <div id="page-local" class="view-page hidden py-20">
                <div class="glass-card p-10 max-w-2xl mx-auto border-dashed border-2 border-white/10 text-center">
                    <input type="file" id="local-input" multiple class="hidden" onchange="handleLocal(this)">
                    <div onclick="document.getElementById('local-input').click()" class="py-20 cursor-pointer group">
                        <i data-lucide="folder-open" class="w-16 h-16 mx-auto mb-4 text-zinc-600 group-hover:text-orange-500"></i>
                        <span class="font-black text-xs text-zinc-500 tracking-widest uppercase block">載入本地影片檔案</span>
                    </div>
                </div>
            </div>

            <!-- 收藏/歷史 頁面 -->
            <div id="page-fav" class="view-page hidden">
                <h2 class="text-3xl font-black mb-10 italic border-l-4 border-orange-500 pl-4 uppercase">My Collection</h2>
                <div id="grid-fav" class="movie-grid"></div>
            </div>
            <div id="page-history" class="view-page hidden">
                <h2 class="text-3xl font-black mb-10 italic border-l-4 border-orange-500 pl-4 uppercase">Watch History</h2>
                <div id="grid-history" class="movie-grid"></div>
            </div>
        </div>
    </main>

    <!-- 播放器模態框 -->
    <div id="player-modal" class="modal-overlay">
        <button onclick="closePlayer()" class="fixed top-8 right-8 z-[1100] p-4 glass-card hover:bg-orange-500 transition"><i data-lucide="x"></i></button>
        <div class="w-full max-w-6xl mt-10">
            <div class="aspect-video bg-black rounded-[2.5rem] overflow-hidden border border-white/10 shadow-2xl mb-8">
                <video id="video-core" class="video-js vjs-big-play-centered w-full h-full" controls></video>
            </div>
            <div class="glass-card p-10">
                <div class="flex flex-col md:flex-row justify-between items-start gap-8">
                    <div>
                        <h1 id="v-title" class="text-4xl font-black italic tracking-tighter mb-2 uppercase">TITLE</h1>
                        <p id="v-desc" class="text-zinc-400 text-sm italic leading-relaxed max-w-2xl">此資源暫無描述資料...</p>
                    </div>
                    <button id="btn-fav" onclick="toggleFav()" class="px-10 py-4 glass-card flex items-center gap-3 font-black hover:bg-orange-600 transition shrink-0">
                        <i data-lucide="heart"></i> <span>儲存</span>
                    </button>
                </div>
                <div id="v-episodes" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3 mt-8 pt-8 border-t border-white/5"></div>
            </div>
        </div>
    </div>

    <!-- 設定後台 -->
    <div id="settings-modal" class="modal-overlay">
        <div class="glass-card p-10 w-full max-w-md relative">
            <h3 class="text-2xl font-black mb-10 text-center text-orange-500 italic uppercase">System Dashboard</h3>
            
            <div class="grid grid-cols-2 gap-3 mb-8">
                <div class="p-4 bg-white/5 rounded-2xl border border-white/5 text-center">
                    <span class="text-[9px] block opacity-50 mb-1 uppercase font-bold">D1 Latency</span>
                    <span id="ping-d1" class="font-black text-sm text-zinc-500">...</span>
                </div>
                <div class="p-4 bg-white/5 rounded-2xl border border-white/5 text-center">
                    <span class="text-[9px] block opacity-50 mb-1 uppercase font-bold">Node Latency</span>
                    <span id="ping-node" class="font-black text-sm text-zinc-500">...</span>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-zinc-500 uppercase tracking-widest block mb-3">視覺模糊模式</label>
                    <div class="flex gap-3">
                        <button onclick="updateMode('glass')" id="btn-m-glass" class="flex-1 py-4 glass-card font-bold text-xs border-2 border-orange-500">Apple Style</button>
                        <button onclick="updateMode('clear')" id="btn-m-clear" class="flex-1 py-4 glass-card font-bold text-xs border-2 border-transparent">Clear View</button>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-zinc-500 uppercase tracking-widest block mb-3">背景桌布網址</label>
                    <input type="text" id="bg-url" placeholder="貼上圖片連結..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl text-xs outline-none focus:border-orange-500">
                </div>
                <div class="flex gap-4 pt-6">
                    <button onclick="saveSettings()" class="flex-1 bg-orange-600 py-4 rounded-2xl font-black shadow-lg">儲存配置</button>
                    <button onclick="openSettings(false)" class="px-8 bg-zinc-800 py-4 rounded-2xl font-black text-xs">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/env';
        let player, currentVod, dbData = { fav: [], history: [] };
        let settings = { bg: "https://images.unsplash.com/photo-1614850523296-d8c1af93d400", mode: "glass" };

        const SOURCES = [
            "https://cj.lziapi.com/api.php/provide/vod/at/json",
            "https://cj.ffzyapi.com/api.php/provide/vod/at/json",
            "https://suoniapi.com/api.php/provide/vod/at/json",
            "https://hhzyapi.com/api.php/provide/vod/at/json",
            "https://api.wlzyapi.com/api.php/provide/vod/at/json",
            "https://sdzyapi.com/api.php/provide/vod/at/json",
            "https://api.tiankongapi.com/api.php/provide/vod/at/json",
            "https://ikunzyapi.com/api.php/provide/vod/at/json",
            "https://bfzyapi.com/api.php/provide/vod/at/json"
        ];

        window.onload = async () => {
            lucide.createIcons();
            player = videojs('video-core', { 
                fluid: true,
                playbackRates: [0.5, 1, 1.5, 2]
            });
            
            await init();

            document.getElementById('searchInput').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') startSearch(e.target.value);
            });
        };

        async function init() {
            // 載入設定
            try {
                const res = await fetch(`${API}?action=get_settings`);
                if(res.ok) settings = await res.json();
                applyUI();
            } catch(e) { applyUI(); }

            // 載入 D1
            try {
                const res = await fetch(`${API}?action=load_db`);
                if(res.ok) dbData = await res.json();
                render('fav', dbData.fav);
                render('history', dbData.history);
            } catch(e) {}

            // 預載首頁
            startSearch('');
        }

        // --- 搜尋邏輯 (保持穩定不動) ---
        async function startSearch(kw) {
            showPage('home');
            const grid = document.getElementById('grid-home');
            const status = document.getElementById('search-status');
            
            status.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse text-orange-500 font-black italic tracking-widest uppercase">Nodes Scanning...</div>';

            const tasks = SOURCES.map(async (url) => {
                const target = kw ? `${url}?wd=${encodeURIComponent(kw)}` : url;
                try {
                    let res = await fetch(target).then(r => r.json());
                    return res.list || [];
                } catch(e) {
                    try {
                        let res = await fetch(`${API}?action=proxy_search&u=${encodeURIComponent(target)}`).then(r => r.json());
                        return res.list || [];
                    } catch(err) { return []; }
                }
            });

            const allRes = await Promise.all(tasks);
            const merged = Array.from(new Map(allRes.flat().map(v => [v.vod_id, v])).values());
            
            status.classList.add('hidden');
            if(merged.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-20 text-center opacity-40 font-black italic">NO DATA FOUND.</div>';
            } else {
                render('home', merged);
            }
        }

        // --- UI 修復與同步 ---
        function render(type, data) {
            const grid = document.getElementById(`grid-${type}`);
            if(!grid) return;
            grid.innerHTML = '';
            data.slice(0, 48).forEach(v => {
                const item = document.createElement('div');
                item.className = "card-item";
                item.onclick = () => openVod(v);
                item.innerHTML = `
                    <div class="aspect-[3/4.2] relative bg-zinc-900">
                        <img src="${v.vod_pic}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://placehold.co/300x420/111/f97316?text=MOVIE'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                        <div class="absolute bottom-2 left-2 bg-orange-600 px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-tighter">${v.vod_remarks || 'HD'}</div>
                    </div>
                    <div class="p-4 text-[11px] font-black truncate text-center opacity-80 uppercase tracking-tighter">${v.vod_name}</div>
                `;
                grid.appendChild(item);
            });
        }

        function openVod(v) {
            currentVod = v;
            document.getElementById('player-modal').classList.add('open');
            document.getElementById('v-title').innerText = v.vod_name;
            document.getElementById('v-desc').innerText = v.vod_content ? v.vod_content.replace(/<[^>]+>/g, '') : "此影視資源暫無詳細介紹。";
            
            const box = document.getElementById('v-episodes');
            box.innerHTML = '';
            const raw = v.vod_play_url || "";
            const eps = raw.includes('#') ? raw.split('#').map(x => x.split('$')) : [raw.split('$')];
            
            eps.forEach((e, i) => {
                const btn = document.createElement('button');
                btn.className = "bg-white/5 border border-white/5 p-4 rounded-xl text-[10px] font-black hover:bg-orange-600 transition truncate";
                btn.innerText = e[0] || `EP${i+1}`;
                btn.onclick = () => {
                    const url = e[e.length-1];
                    player.src({ src: url, type: url.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4' });
                    player.play();
                    saveHistory(v);
                };
                box.appendChild(btn);
            });
            if(box.firstChild) box.firstChild.click();
            updateFavBtn();
        }

        // --- 功能模塊 ---
        async function saveSettings() {
            const url = document.getElementById('bg-url').value;
            if(url) settings.bg = url;
            await fetch(`${API}?action=set_settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payload: settings })
            });
            applyUI();
            openSettings(false);
        }

        function applyUI() {
            const layer = document.getElementById('bg-layer');
            layer.style.backgroundImage = `url('${settings.bg}')`;

layer.classList.toggle('glass-mode', settings.mode === 'glass');
            document.getElementById('btn-m-glass').style.borderColor = settings.mode === 'glass' ? '#f97316' : 'transparent';
            document.getElementById('btn-m-clear').style.borderColor = settings.mode === 'clear' ? '#f97316' : 'transparent';
        }

        async function syncDB() {
            fetch(`${API}?action=sync_db`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ payload: dbData })
            });
        }

        function toggleFav() {
            const idx = dbData.fav.findIndex(x => x.vod_id === currentVod.vod_id);
            if(idx > -1) dbData.fav.splice(idx, 1);
            else dbData.fav.unshift(currentVod);
            render('fav', dbData.fav);
            syncDB();
            updateFavBtn();
        }

        function updateFavBtn() {
            const isFav = dbData.fav.some(x => x.vod_id === currentVod.vod_id);
            const btn = document.getElementById('btn-fav');
            btn.classList.toggle('bg-orange-600', isFav);
            btn.querySelector('span').innerText = isFav ? '已儲存' : '儲存收藏';
        }

        function saveHistory(v) {
            dbData.history = [v, ...dbData.history.filter(x => x.vod_id !== v.vod_id)].slice(0, 48);
            render('history', dbData.history);
            syncDB();
        }

        function checkLatency() {
            const s1 = Date.now();
            fetch(`${API}?action=ping`).then(() => document.getElementById('ping-d1').innerText = (Date.now()-s1)+'ms');
            const s2 = Date.now();
            fetch(SOURCES[0]).then(() => document.getElementById('ping-node').innerText = (Date.now()-s2)+'ms');
        }

        // --- 全域控制 ---
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');
        window.showPage = p => {
            document.querySelectorAll('.view-page').forEach(v => v.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(`n-${p}`).classList.add('active');
            if(window.innerWidth < 1024) toggleSidebar();
        };
        window.openSettings = s => {
            document.getElementById('settings-modal').classList.toggle('open', s);
            if(s) checkLatency();
        };
        window.updateMode = m => { settings.mode = m; applyUI(); };
        window.closePlayer = () => { player.pause(); document.getElementById('player-modal').classList.remove('open'); };
        window.playM3U8 = () => {
            const u = document.getElementById('m3u8-url').value;
            if(u) openVod({ vod_name: "M3U8 解析", vod_play_url: `STREAM$${u}`, vod_id: 'm3u8' });
        };
        window.handleLocal = i => {
            const fs = Array.from(i.files).map(f => `${f.name}$${URL.createObjectURL(f)}`);
            if(fs.length) openVod({ vod_name: "本地檔案", vod_play_url: fs.join('#'), vod_id: 'local' });
        };
    </script>
</body>
</html>

            