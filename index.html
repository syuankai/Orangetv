<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORANGEPLAYER PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root { --orange: #f97316; --sidebar-w: 260px; }
        
        body { 
            font-family: 'SF Pro Display', 'Noto Sans TC', sans-serif; 
            background: #000; color: #fff; height: 100vh; overflow: hidden; display: flex; 
        }

        #bg-layer { 
            position: fixed; inset: 0; z-index: -1; 
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80') center/cover;
        }
        #bg-layer::after { 
            content: ''; position: absolute; inset: 0; 
            backdrop-filter: blur(60px) saturate(150%); 
            background: linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.9)); 
        }

        #sidebar {
            width: var(--sidebar-w); background: rgba(0, 0, 0, 0.4);
            border-right: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(40px);
            z-index: 1000; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; height: 100vh;
        }
        #sidebar.collapsed { transform: translateX(-100%); }

        #menu-toggle-btn {
            position: absolute; right: -52px; top: 20px;
            width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 999px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; z-index: 1001;
        }
        #menu-toggle-btn:hover { background: var(--orange); }

        #main-container {
            flex: 1; display: flex; flex-direction: column; width: 100%;
            padding-left: var(--sidebar-w); transition: padding-left 0.4s;
        }
        body.is-collapsed #main-container { padding-left: 0; }

        header { padding: 20px 30px; display: flex; justify-content: flex-end; z-index: 40; }
        .search-wrap { width: 100%; max-width: 380px; margin-left: 60px; }

        .movie-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; padding-bottom: 100px; 
        }
        
        .card-item { 
            border-radius: 12px; background: rgba(255,255,255,0.04); 
            border: 1px solid rgba(255,255,255,0.06); transition: 0.3s; 
            overflow: hidden; cursor: pointer; position: relative;
        }
        .card-item:hover { transform: translateY(-5px); border-color: var(--orange); }

        .modal-overlay { position: fixed; inset: 0; z-index: 2000; display: none; background: rgba(0,0,0,0.95); backdrop-filter: blur(50px); overflow-y: auto; }
        .modal-overlay.open { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .nav-btn { display: flex; align-items: center; padding: 12px 18px; border-radius: 12px; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.35); font-weight: 700; margin: 4px 0; font-size: 13px; }
        .nav-btn.active { background: var(--orange) !important; color: #fff !important; }

        /* 修復手機端延遲監控顯示 */
        .stats-area {
            margin-top: auto; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.05);
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; text-align: center;
        }

        @media (max-width: 768px) {
            :root { --sidebar-w: 240px; }
            .movie-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
            .search-wrap { margin-left: 50px; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="is-collapsed">
    <div id="bg-layer"></div>

    <aside id="sidebar" class="collapsed">
        <div id="menu-toggle-btn" onclick="toggleSidebar()"><i data-lucide="menu" class="w-5 h-5 text-white"></i></div>
        <div class="p-6 h-full flex flex-col">
            <!-- LOGO -->
            <div class="flex items-center gap-3 mb-10">
                <div class="bg-orange-500 p-2 rounded-lg"><i data-lucide="play" class="w-5 h-5 fill-white text-white"></i></div>
                <div class="flex flex-col leading-none">
                    <span class="text-xl font-black italic tracking-tighter">ORANGE</span>
                    <span class="text-[8px] font-bold text-orange-500 tracking-widest uppercase">Player Pro</span>
                </div>
            </div>

            <nav class="flex-1 space-y-1">
                <div onclick="showPage('home')" id="n-home" class="nav-btn active"><i data-lucide="layout-grid" class="w-4 h-4 mr-3"></i>影視探索</div>
                <div onclick="showPage('m3u8')" id="n-m3u8" class="nav-btn"><i data-lucide="link" class="w-4 h-4 mr-3"></i>M3U8 解析</div>
                <div onclick="showPage('local')" id="n-local" class="nav-btn"><i data-lucide="music" class="w-4 h-4 mr-3"></i>本地音樂</div>
                <div onclick="showPage('fav')" id="n-fav" class="nav-btn"><i data-lucide="heart" class="w-4 h-4 mr-3"></i>我的儲存</div>
                <div onclick="showPage('history')" id="n-history" class="nav-btn"><i data-lucide="history" class="w-4 h-4 mr-3"></i>觀看歷史</div>
            </nav>

            <div class="stats-area">
                <div class="stat-box">
                    <div class="text-[7px] text-zinc-500 font-bold uppercase">D1 Sync</div>
                    <div id="stat-d1" class="text-[9px] font-black tracking-tighter">-- MS</div>
                </div>
                <div class="stat-box">
                    <div class="text-[7px] text-zinc-500 font-bold uppercase">Source</div>
                    <div id="stat-src" class="text-[9px] font-black tracking-tighter">-- MS</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="main-container">
        <header>
            <div class="search-wrap relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 w-3.5 h-3.5"></i>
                <input type="text" id="searchInput" placeholder="搜尋影片/資源..." class="w-full bg-white/5 border border-white/10 p-3.5 pl-11 rounded-xl outline-none focus:border-orange-500 transition-all text-xs font-bold shadow-xl">
            </div>
        </header>

        <main class="flex-1 overflow-y-auto px-6 md:px-10 custom-scrollbar">
            <div id="page-home" class="view">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-black italic border-l-4 border-orange-500 pl-4 uppercase tracking-tighter">Trending</h2>
                    <span class="text-[9px] font-bold text-orange-500/50 uppercase tracking-[0.3em]">Direct Fetch Mode</span>
                </div>
                <div id="grid-home" class="movie-grid"></div>
            </div>
            <div id="page-fav" class="view hidden"><h2 class="text-2xl font-black italic mb-6 border-l-4 border-orange-500 pl-4 uppercase">Favorites</h2><div id="grid-fav" class="movie-grid"></div></div>
            <div id="page-history" class="view hidden"><h2 class="text-2xl font-black italic mb-6 border-l-4 border-orange-500 pl-4 uppercase">History</h2><div id="grid-history" class="movie-grid"></div></div>
            <div id="page-m3u8" class="view hidden">
                <div class="p-10 max-w-md mx-auto mt-10 text-center bg-white/5 rounded-3xl border border-white/10 shadow-2xl">
                    <h2 class="text-xs font-black mb-6 text-orange-500 uppercase tracking-widest">M3U8 Parser</h2>
                    <input type="text" id="m3u8-url" placeholder="Paste .m3u8 URL here" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl mb-4 text-center text-xs outline-none">
                    <button onclick="playM3U8()" class="w-full bg-orange-600 hover:bg-orange-500 py-3.5 rounded-xl font-black text-[10px] uppercase">Analyze & Play</button>
                </div>
            </div>
            <div id="page-local" class="view hidden">
                <div class="p-20 max-w-md mx-auto mt-10 border-dashed border-2 border-white/10 rounded-3xl text-center group cursor-pointer" onclick="document.getElementById('local-input').click()">
                    <input type="file" id="local-input" multiple accept="audio/*,video/*" class="hidden" onchange="handleLocal(this)">
                    <i data-lucide="music" class="w-10 h-10 mx-auto mb-4 opacity-20 group-hover:text-orange-500 transition-all"></i>
                    <div class="font-black text-[10px] text-zinc-500 uppercase">Load Local Media</div>
                </div>
            </div>
        </main>
    </div>

    <!-- 播放器模態框 -->
    <div id="player-modal" class="modal-overlay">
        <button onclick="closePlayer()" class="fixed top-6 right-6 p-4 bg-white/5 border border-white/10 rounded-2xl z-[2100]"><i data-lucide="x" class="w-5 h-5"></i></button>
        <div class="w-full max-w-[1000px] mt-2 mb-10">
            <div class="aspect-video bg-black rounded-[24px] overflow-hidden shadow-2xl border border-white/10 mb-6">
                <video id="video-core" class="video-js vjs-big-play-centered w-full h-full" controls preload="auto"></video>
            </div>
            <div class="bg-white/5 border border-white/10 rounded-3xl p-6 flex flex-col md:flex-row gap-6">
                <div class="w-32 flex-shrink-0 hidden md:block">
                    <img id="v-poster" class="w-full aspect-[3/4.2] rounded-xl object-cover">
                </div>
                <div class="flex-1">
                    <div class="border-b border-white/5 pb-4 mb-4 flex justify-between items-start">
                        <div>
                            <h2 id="v-title" class="text-xl font-black italic mb-2 tracking-tighter">---</h2>
                            <div class="flex items-center gap-3">
                                <span id="v-remarks" class="bg-orange-600 px-2 py-0.5 rounded text-[8px] font-bold">HD</span>
                                <span id="v-ping" class="text-[8px] font-bold text-zinc-500 uppercase tracking-widest">Latency: --</span>
                            </div>
                        </div>
                        <button id="v-fav-btn" onclick="toggleFav()" class="text-orange-500 text-[10px] font-bold flex items-center gap-1"><i data-lucide="heart" class="w-3.5 h-3.5"></i> 儲存</button>
                    </div>
                    <div id="v-episodes" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 mb-4 max-h-[120px] overflow-y-auto custom-scrollbar"></div>
                    <p id="v-desc" class="text-[10px] text-zinc-500 line-clamp-3 leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api/env';
        // 類 MoonTV 推薦邏輯常用的資源站 API
        const SOURCES = [
            "https://cj.lziapi.com/api.php/provide/vod/at/json",
            "https://cj.ffzyapi.com/api.php/provide/vod/at/json"
        ];
        
        let player, dbData = { fav: [], history: [] }, currentVod = null;

        window.onload = async () => {
            lucide.createIcons();
            player = videojs('video-core', { fluid: true, playbackRates: [0.5, 1, 1.5, 2] });
            startStatMonitor();
            syncCloud();
            document.getElementById('searchInput').addEventListener('keydown', e => e.key === 'Enter' && startSearch(e.target.value));
            loadHome(); // 初始加載首頁推薦
        };

        async function startStatMonitor() {
            const check = async () => {
                const start = Date.now();
                fetch(`${API}?action=load_db`).then(() => {
                    document.getElementById('stat-d1').innerText = (Date.now() - start) + ' MS';
                }).catch(() => {});
            };
            check(); setInterval(check, 20000);
        }

        async function syncCloud() {
            try {
                const db = await fetch(`${API}?action=load_db`).then(r => r.json());
                dbData = db; render('fav', dbData.fav); render('history', dbData.history);
            } catch(e) {}
        }

        // 核心邏輯：直接向資源站發送請求 (類 MoonTV 實現)
        async function fetchSource(url, params = "") {
            try {
                const start = Date.now();
                const res = await fetch(`${url}${params}`, { method: 'GET' });
                const data = await res.json();
                document.getElementById('stat-src').innerText = (Date.now() - start) + ' MS';
                return data.list || [];
            } catch (e) {
                console.error("Fetch Error:", e);
                return [];
            }
        }

        async function loadHome() {
            const grid = document.getElementById('grid-home');
            grid.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse text-[10px] font-black text-orange-500 uppercase tracking-widest">Syncing with Mainframe...</div>';
            
            // 類 MoonTV 首頁邏輯：請求最新更新的資源
            const results = await Promise.all(SOURCES.map(url => fetchSource(url, "?ac=detail")));
            let flat = Array.from(new Map(results.flat().map(v => [v.vod_id, v])).values());
            
            // 按時間排序並篩選
            flat = flat.sort((a, b) => new Date(b.vod_time) - new Date(a.vod_time)).slice(0, 48);
            render('home', flat);
        }

        async function startSearch(kw) {
            if(!kw) return loadHome();
            const grid = document.getElementById('grid-home');
            grid.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse text-[10px] font-black text-orange-500 uppercase tracking-widest">Searching Nodes...</div>';
            
            const results = await Promise.all(SOURCES.map(url => fetchSource(url, `?wd=${encodeURIComponent(kw)}`)));
            let flat = Array.from(new Map(results.flat().map(v => [v.vod_id, v])).values());
            render('home', flat);
        }

        function render(type, data) {
            const grid = document.getElementById(`grid-${type}`);
            if(!grid) return; grid.innerHTML = '';
            if(!data.length) { grid.innerHTML = '<div class="col-span-full py-10 text-center text-zinc-800 text-[8px] font-bold uppercase tracking-widest">Nothing Found</div>'; return; }
            data.forEach(v => {
                const d = document.createElement('div');
                d.className = "card-item";
                d.onclick = () => openVod(v, true);
                d.innerHTML = `
                    <div class="aspect-[3/4.2] relative bg-zinc-900">
                        <img src="${v.vod_pic}" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent"></div>
                        <div class="absolute bottom-1 left-1 bg-orange-600/90 px-1 py-0.5 rounded text-[7px] font-bold">${v.vod_remarks || 'HD'}</div>
                    </div>
                    <div class="p-2 text-[8px] font-bold truncate text-center opacity-60 uppercase">${v.vod_name}</div>
                `;
                grid.appendChild(d);
            });
        }

        function openVod(v, autoPlay = false) {
            currentVod = v;
            document.getElementById('player-modal').classList.add('open');
            document.getElementById('v-title').innerText = v.vod_name;
            document.getElementById('v-poster').src = v.vod_pic;
            document.getElementById('v-remarks').innerText = v.vod_remarks || 'HD';
            document.getElementById('v-desc').innerText = (v.vod_content || '').replace(/<[^>]+>/g, '');
            
            const box = document.getElementById('v-episodes'); box.innerHTML = '';
            const raw = v.vod_play_url || "";
            // 通用 M3U8 解析邏輯
            const eps = raw.includes('#') ? raw.split('#').map(x => x.split('$')) : [raw.split('$')];
            
            eps.forEach((e, i) => {
                const btn = document.createElement('button');
                btn.className = "px-1 py-2 bg-white/5 border border-white/5 rounded-lg text-[8px] font-bold hover:bg-orange-600 transition truncate";
                btn.innerText = e[0] || `EP${i+1}`;
                btn.onclick = () => playEpisode(e[e.length-1], btn);
                box.appendChild(btn);
                if(autoPlay && i === 0) playEpisode(e[e.length-1], btn);
            });
            lucide.createIcons();
        }

        function playEpisode(u, btn) {
            const start = Date.now();
            player.src({ src: u, type: u.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4' });
            player.play();
            player.one('canplay', () => {
                document.getElementById('v-ping').innerText = `Latency: ${Date.now() - start}ms`;
            });
            saveHistory(currentVod);
            document.getElementById('v-episodes').querySelectorAll('button').forEach(b => b.classList.remove('bg-orange-600'));
            btn.classList.add('bg-orange-600');
        }

        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.body.classList.toggle('is-collapsed'); 
        }

        function showPage(p) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(l => l.classList.remove('active'));
            document.getElementById(`n-${p}`).classList.add('active');
            if (window.innerWidth < 768) toggleSidebar();
        }

        async function toggleFav() {
            const idx = dbData.fav.findIndex(x => x.vod_id === currentVod.vod_id);
            if(idx > -1) dbData.fav.splice(idx, 1); else dbData.fav.unshift(currentVod);
            render('fav', dbData.fav);
            fetch(`${API}?action=sync_db`, { method: 'POST', body: JSON.stringify({ payload: dbData }) });
        }

        function saveHistory(v) {
            dbData.history = [v, ...dbData.history.filter(x => x.vod_id !== v.vod_id)].slice(0, 30);
            render('history', dbData.history);
            fetch(`${API}?action=sync_db`, { method: 'POST', body: JSON.stringify({ payload: dbData }) });
        }

        window.closePlayer = () => { player.pause(); document.getElementById('player-modal').classList.remove('open'); };
        window.playM3U8 = () => {
            const u = document.getElementById('m3u8-url').value;
            if(u) openVod({ vod_name: "REMOTE STREAM", vod_play_url: `M3U8$${u}`, vod_id: Date.now(), vod_pic: 'https://images.unsplash.com/photo-1594908900066-3f47337549d8' }, true);
        };
        window.handleLocal = i => {
            const files = Array.from(i.files).map(f => `${f.name}$${URL.createObjectURL(f)}`);
            if(files.length) openVod({ vod_name: "LOCAL FILES", vod_play_url: files.join('#'), vod_id: 'local', vod_pic: 'https://images.unsplash.com/photo-1614850523296-d8c1af93d400' }, true);
        };
    </script>
</body>
</html>